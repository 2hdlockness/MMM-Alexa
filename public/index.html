<html>
  <head>
  <meta charset="UTF-8">
  <title>MMM-Alexa ~ Code generator for AVS Authentication</title>
  <style>
  body {
	background-image: url('background1.png');
	background-repeat: no-repeat;
	background-position: center center;
	background-size: cover;
	background-attachment: fixed;
  }
  .text {
	color:#FFF;
  }  
  </style>
    <script type="text/javascript">
      function getUri() {
        return window.location.href.split('?')[0];
      }

      function requestCode(){
        var clientId = document.getElementById('clientId').value;
        var deviceId = document.getElementById('deviceId').value;
        var deviceSerialNumber = document.getElementById('deviceSerialNumber').value;
        var redirectUri = getUri()

        var scopeData = {
            "alexa:all": {
                productID: deviceId,
                productInstanceAttributes: {
                    deviceSerialNumber: deviceSerialNumber
                }
            }
        }

        var authUrl = "https://www.amazon.com/ap/oa?client_id=" + clientId + "&scope=alexa%3Aall&scope_data=" + encodeURIComponent(JSON.stringify(scopeData))+ "&response_type=code&redirect_uri=" + encodeURI(redirectUri);
        window.location.href = authUrl;
      }

      function getParameterByName(name) {
          url = window.location.href;

          name = name.replace(/[\[\]]/g, "\\$&");
          var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
          var results = regex.exec(url);
          if (!results) return null;
          if (!results[2]) return '';
          return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      document.addEventListener("DOMContentLoaded", function(event) {
        var initialCode = getParameterByName('code');
        var request= document.getElementById('request')
        var requestedUri= document.getElementById('uri')
        if (initialCode){
          request.style.display = "none";
          document.getElementById('code').innerHTML = "Your InitialCode: " + "<b>" + initialCode + "</b>";
        }
      });
    </script>
  </head>  
  <body>
  <div style="min-height: calc(100vh - 50px);" class="text">
    <h1><img style="margin-right:10px" src="alexa.gif" width="50px" height="50px" align="center"/>Code generator for AVS Authentication</h1>
    <div id= "request">
      <div id= "uri"></div>
      <div>
        <p>Welcome to the inital code generator for MMM-Alexa<br><br>
      </div>
      <div>
        <table>
          <tbody>
            <tr>
              <td style="color:#fff;text-align: center;">Client ID</td>
              <td><input id="clientId" size="60"/></td>
            </tr>
            <tr>
              <td style="color:#fff;text-align: center;">Product ID</td>
              <td><input id="deviceId" size="60"/></td>
            </tr>
            <tr>
              <td style="color:#fff;width: 150px;text-align: center;">Device serial number</td>
              <td><input id="deviceSerialNumber" value="1234"/></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div>
        <p><br>This generator will allow to link MMM-Alexa to your amazon account.<br>
        It will return the initial code for your module configuration (InitialCode).
        </p>
      </div>
      <input type="button" id="request_code" value="Request your InitialCode" onClick="requestCode();"/>
      <div>
        <p>You can get support in <A href="http://forum.bugsounet.fr" style="color: dodgerblue;">4th Party modules</A></p>
      </div>
    </div>
    <div id="code"></div>
  </div>
  <footer style="height: 10px;color: #fff">
    <p>Designed by @2hdlockness ~ Â©bugsounet.fr 2021 ~</p>
  </footer>
  </body>
</html>
